---
title: "Reticulate test"
output: html_notebook
---

Import other functions from R script
```{r}
source("./r_analysis.R")
```

```{r}
copytree_path <- "/Users/zemp/phd/scilife/coPyTree"
```

Read numpy file

```{r}
diag_list <- read_diagnostics(file.path(copytree_path, "output/diagnostics"))
```

Import ggplot
```{r}
library(ggplot2)
library(ggpubr)
library(tibble)

n_iter <- dim(diag_list$copy_num)[1]
K <- dim(diag_list$copy_num)[2]
M <- dim(diag_list$copy_num)[3]
A <- dim(diag_list$copy_num)[4]
N <- dim(diag_list$cell_assignment)[2]
```

```{r}
plot_elbo(diag_list)
```

# Ground truth comparison

```{r}
gt_list <- read_gt(file.path(
  copytree_path,
  "datasets/gt_simul_K4_A5_N100_M500"
))
```

## Clustering evaluation

Clustering matchings table
print vi clones map associated with ground truth

```{r}
gt_vi_map <- plot_ari(diag_list, gt_list)
```

```{r}
# usage: to get the correspondent clone in vi names
k <- 1
gt_vi_map %>%
  filter(gt == k) %>%
  pull(vi)
```

## Cell assignment

```{r}
# diag_list$cell_assignment shape (n_iter, N, K)
library(reshape2)
library(dplyr)
plot_cell_assignment(diag_list, gt_list, gtvi_map = gt_vi_map)
```


## Copy number plot
TODO: improve by plotting probability mass on each state with color scale mapping
```{r}
# select node 1 (with take, axis=1, el=1) and argmax
# np <- import("numpy")
# copy_max_node1 <- np$argmax(np$take(diag_list$copy_num, 1L, 1L), axis=-1L)
# or in base R
plot_copy(diag_list, gt_list, gtvi_map = gt_vi_map)
```
TODO: implement quick comparison with true and inferred tree, clustering, copy
numbers etc


## Tree evaluation

```{r}
library(tidyr)

plot_eps(diag_list, gt_list, gt_vi_map)
```

## Copy eval

```{r}
li <- list()
for (k in 1:K) {
  copy_it_k <- apply(diag_list$copy_num[n_iter, k, , ], 1, which.max) - 1L
  copy_tibble <- tibble(cn = c(copy_it_k, gt_list$copy_num[k, ]), site = c(1:M, 1:M), kind = c(rep("vi", M), rep("gt", M)))
  p <- ggplot(copy_tibble) +
    geom_line(aes(x = site, y = cn, color = kind)) +
    geom_line(aes(x = site, y = cn, color = kind, linetype = kind)) +
    labs(title = paste("CN clone", k - 1L)) +
    scale_y_continuous(breaks = 1:A - 1L)
  li[[k]] <- p
}
ggarrange(plotlist = li, nrow = K, ncol = 1L)
```
